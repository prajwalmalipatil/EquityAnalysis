name: Daily Equity Analysis Pipeline

on:
  push:
    branches: [ main ]
  schedule:
    # Runs at 17:07 IST (11:37 UTC) | Monday to Friday only
    - cron: '37 11 * * 1-5'
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: "Run Stage 1: Extraction"
      run: |
        python NSE_extraction_fast_api.py \
          --symbols "$(cat symbols.txt | tr '\n' ',' | sed 's/,$//')" \
          --out-dir equity_data \
          --overwrite \
          --no-browser \
          --workers 10
      continue-on-error: true

    - name: "Run Stage 2: VSA Processing"
      run: python vsa_processor.py --folder equity_data

    - name: "Run Notification & Summary"
      env:
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECIPIENT_EMAIL: "Prajwalmalipatil@gmail.com"
        GITHUB_ACTIONS: "true"
      run: python automation_notifier.py

    - name: Upload Results as Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: equity-analysis-results
        path: |
          equity_data/Results/
          equity_data/Ticker/
          equity_data/Trending/
        retention-days: 7
